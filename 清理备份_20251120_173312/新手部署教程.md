# XianyuAutoAgent 新手部署教程

## Docker 是什么？

把 Docker 想象成一个"集装箱"：
- **集装箱（容器）**：你的应用程序 + 运行环境打包在一起
- **好处**：在任何安装了 Docker 的机器上都能运行，不用担心"我的电脑能跑，你的电脑跑不了"

**传统方式 vs Docker 方式：**

```
传统方式（麻烦）：
你的电脑 → 安装Python → 安装Node.js → 安装依赖 → 配置环境变量 → 运行
服务器   → 又要重复一遍上面的步骤...

Docker 方式（简单）：
本地电脑 → 构建 Docker 镜像（相当于打包）
服务器   → 直接运行镜像，不用再安装任何东西
```

---

## 一、本地运行步骤（开发/测试）

### 前提条件

你的 Mac 需要先安装 Docker。

#### 安装 Docker Desktop（只需要做一次）

1. **下载 Docker Desktop**
   - 访问：https://www.docker.com/products/docker-desktop
   - 选择 Mac 版本下载
   - 如果是 M1/M2 芯片，选择 "Apple Silicon"
   - 如果是 Intel 芯片，选择 "Intel Chip"

2. **安装**
   - 双击下载的 `.dmg` 文件
   - 把 Docker 图标拖到 Applications 文件夹
   - 打开 Docker Desktop
   - 等待它启动完成（状态栏会显示 Docker 图标）

3. **验证安装**
   ```bash
   # 打开终端，输入以下命令
   docker --version
   # 应该显示类似：Docker version 24.0.6

   docker-compose --version
   # 应该显示类似：Docker Compose version v2.21.0
   ```

### 本地运行步骤

```bash
# ===== 步骤 1：打开终端，进入项目目录 =====
cd /Users/q/Desktop/xianyu


# ===== 步骤 2：配置环境变量（重要！）=====
cd XianyuAutoAgent
cp .env.example .env

# 用文本编辑器打开 .env 文件
open .env
# 或者用 VS Code 打开
# code .env

# 填写必要的配置，比如：
# DOUBAO_API_KEY=你的API密钥
# XIANYU_COOKIE=你的闲鱼Cookie
# 保存并关闭


# ===== 步骤 3：回到项目根目录 =====
cd ..


# ===== 步骤 4：构建 Docker 镜像（首次运行需要，会花几分钟）=====
./deploy.sh build

# 这一步在做什么？
# - 读取 Dockerfile 配置
# - 下载 Python、Node.js 等基础镜像
# - 安装项目所有依赖
# - 打包成 3 个镜像：前端、后端API、AI Agent


# ===== 步骤 5：启动所有服务 =====
./deploy.sh start

# 这一步在做什么？
# - 启动 3 个 Docker 容器
# - 容器之间自动建立网络连接
# - 映射端口到你的电脑


# ===== 步骤 6：访问应用 =====
# 打开浏览器访问：
# 前端页面：http://localhost
# 后端 API：http://localhost:5000


# ===== 查看运行状态 =====
./deploy.sh status

# 输出示例：
# NAME           STATUS    PORTS
# xianyu-admin   Up        0.0.0.0:80->80/tcp
# xianyu-api     Up        0.0.0.0:5000->5000/tcp
# xianyu-agent   Up


# ===== 查看日志（如果出错了看这里）=====
./deploy.sh logs

# 或者查看单个服务的日志：
docker-compose logs -f xianyu-api      # 查看后端日志
docker-compose logs -f xianyu-agent    # 查看 Agent 日志
docker-compose logs -f xianyu-admin    # 查看前端日志


# ===== 停止服务（不用的时候）=====
./deploy.sh stop


# ===== 重启服务（修改了配置后）=====
./deploy.sh restart
```

### 本地运行流程图

```
┌─────────────────────────────────────────────────────┐
│ 1. 配置 .env 文件（填写 API Key 等）                 │
└─────────────────┬───────────────────────────────────┘
                  ↓
┌─────────────────────────────────────────────────────┐
│ 2. ./deploy.sh build（构建镜像，首次需要 5-10 分钟）│
└─────────────────┬───────────────────────────────────┘
                  ↓
┌─────────────────────────────────────────────────────┐
│ 3. ./deploy.sh start（启动服务，几秒钟）            │
└─────────────────┬───────────────────────────────────┘
                  ↓
┌─────────────────────────────────────────────────────┐
│ 4. 打开浏览器访问 http://localhost                   │
└─────────────────────────────────────────────────────┘
```

---

## 二、服务器部署步骤

假设你有一台服务器（比如阿里云、腾讯云）。

### 方式一：导出镜像部署（推荐，适合网速慢的服务器）

这种方式是在**你自己电脑上打包好**，然后上传到服务器直接用。

#### 在你的 Mac 上操作：

```bash
# ===== 步骤 1：进入项目目录 =====
cd /Users/q/Desktop/xianyu


# ===== 步骤 2：构建镜像（如果还没构建过）=====
./deploy.sh build


# ===== 步骤 3：导出镜像包 =====
./deploy.sh export

# 这一步在做什么？
# - 把 3 个 Docker 镜像打包成 .tar.gz 文件
# - 复制 docker-compose.yml、.env 等配置文件
# - 生成一个服务器端部署脚本
# - 所有文件都放在 export/ 目录里

# 导出完成后，会看到：
# export/
# ├── xianyu-api.tar.gz         (Python 后端镜像，约 200MB)
# ├── xianyu-agent.tar.gz       (AI Agent 镜像，约 200MB)
# ├── xianyu-admin.tar.gz       (前端镜像，约 50MB)
# ├── docker-compose.yml        (服务编排配置)
# ├── .env                      (环境变量)
# ├── data/                     (数据目录，如果有)
# └── deploy-server.sh          (服务器端一键部署脚本)


# ===== 步骤 4：上传到服务器 =====
# 假设你的服务器信息：
# - IP 地址：123.456.789.10
# - 用户名：root
# - 要部署到服务器的 /opt/xianyu 目录

scp -r export/ root@123.456.789.10:/opt/xianyu/

# 或者用 SFTP 工具上传（图形界面更友好）：
# - FileZilla
# - Cyberduck
# - Transmit
```

#### 在服务器上操作：

```bash
# ===== 步骤 1：SSH 连接到服务器 =====
ssh root@123.456.789.10


# ===== 步骤 2：安装 Docker（如果服务器还没装）=====

# Ubuntu/Debian 系统：
curl -fsSL https://get.docker.com | sh
systemctl start docker
systemctl enable docker

# CentOS 系统：
curl -fsSL https://get.docker.com | sh
systemctl start docker
systemctl enable docker

# 验证安装
docker --version


# ===== 步骤 3：进入部署目录 =====
cd /opt/xianyu/export


# ===== 步骤 4：运行一键部署脚本 =====
chmod +x deploy-server.sh
./deploy-server.sh

# 这个脚本会自动：
# 1. 加载 3 个镜像文件（docker load）
# 2. 启动所有服务（docker-compose up -d）


# ===== 步骤 5：检查服务状态 =====
docker-compose ps

# 应该看到 3 个服务都是 "Up" 状态


# ===== 步骤 6：访问应用 =====
# 在浏览器中访问：
# http://你的服务器IP

# 例如：http://123.456.789.10
```

### 方式二：源码部署（适合服务器网速快）

这种方式是把**源代码**上传到服务器，在服务器上构建。

```bash
# ===== 在你的 Mac 上 =====

# 1. 把整个项目打包上传
cd /Users/q/Desktop
tar -czf xianyu.tar.gz xianyu/
scp xianyu.tar.gz root@123.456.789.10:/opt/


# ===== 在服务器上 =====

# 1. SSH 连接
ssh root@123.456.789.10

# 2. 解压项目
cd /opt
tar -xzf xianyu.tar.gz
cd xianyu

# 3. 确保 Docker 已安装（同方式一）

# 4. 配置环境变量
cd XianyuAutoAgent
vi .env  # 填写配置
cd ..

# 5. 构建并启动（会在服务器上下载依赖，比较慢）
./deploy.sh build
./deploy.sh start

# 6. 访问
# http://你的服务器IP
```

---

## 三、常用操作

### 查看服务状态

```bash
./deploy.sh status

# 或者
docker-compose ps
```

### 查看日志

```bash
# 查看所有日志
./deploy.sh logs

# 实时查看某个服务的日志
docker-compose logs -f xianyu-api
```

### 停止服务

```bash
./deploy.sh stop
```

### 重启服务

```bash
./deploy.sh restart
```

### 修改配置后重启

```bash
# 1. 修改 .env 文件
vi XianyuAutoAgent/.env

# 2. 重启服务
./deploy.sh restart
```

### 完全重新部署

```bash
# 停止并删除所有容器
docker-compose down

# 重新构建
./deploy.sh build

# 启动
./deploy.sh start
```

---

## 四、图解架构

```
┌─────────────────────────────────────────────────────────┐
│                       你的电脑/服务器                      │
│                                                           │
│  ┌─────────────┐  ┌──────────────┐  ┌─────────────┐    │
│  │  容器 1      │  │   容器 2      │  │   容器 3     │    │
│  │  前端        │  │   后端 API    │  │  AI Agent   │    │
│  │  (Nginx)    │  │  (Python)    │  │  (Python)   │    │
│  │  端口 80    │  │   端口 5000   │  │             │    │
│  └──────┬──────┘  └───────┬──────┘  └──────┬──────┘    │
│         │                  │                 │           │
│         └──────────────────┴─────────────────┘           │
│                    内部网络（自动连接）                    │
│                                                           │
└─────────────────────────────────────────────────────────┘
         │                            │
         │                            │
    浏览器访问                    API 调用
   http://localhost          http://localhost:5000
```

---

## 五、对比总结

| 步骤 | 本地开发 | 服务器部署（方式一） | 服务器部署（方式二） |
|------|----------|---------------------|---------------------|
| 1. 安装 Docker | 在 Mac 安装 | 在服务器安装 | 在服务器安装 |
| 2. 配置 .env | ✓ | ✓ | ✓ |
| 3. 构建镜像 | `./deploy.sh build` | 在 Mac: `./deploy.sh export` | 在服务器: `./deploy.sh build` |
| 4. 上传 | - | `scp export/` | `scp xianyu.tar.gz` |
| 5. 部署 | `./deploy.sh start` | `./deploy-server.sh` | `./deploy.sh start` |
| 网络要求 | 需要下载依赖 | Mac 下载，服务器不需要 | 服务器需要下载依赖 |
| 速度 | 快 | 最快 | 慢（服务器构建） |

---

## 六、故障排查

### 问题 1：Docker 命令找不到

```bash
# 检查 Docker 是否运行
docker --version

# 如果提示 "command not found"
# → 需要安装 Docker Desktop（见上面安装步骤）

# 如果提示 "Cannot connect to Docker daemon"
# → Docker Desktop 没有启动，打开应用程序里的 Docker
```

### 问题 2：端口被占用

```bash
# 错误信息：Error: bind: address already in use

# 查看哪个程序占用了端口
sudo lsof -i :80
sudo lsof -i :5000

# 方案 1：停止占用端口的程序
# 方案 2：修改 docker-compose.yml 中的端口映射
```

### 问题 3：构建失败

```bash
# 清理 Docker 缓存
docker system prune -a

# 重新构建
./deploy.sh build
```

### 问题 4：服务器无法访问

```bash
# 1. 检查服务是否启动
docker-compose ps

# 2. 检查防火墙
# Ubuntu/Debian:
sudo ufw allow 80
sudo ufw allow 5000

# CentOS:
sudo firewall-cmd --add-port=80/tcp --permanent
sudo firewall-cmd --reload

# 3. 检查云服务器安全组
# 去云服务器控制台，开放 80 和 5000 端口
```

---

## 七、下一步

1. **访问前端页面**：http://localhost（本地）或 http://你的服务器IP
2. **配置闲鱼 Cookie**：在前端页面的设置中填写
3. **测试 AI 回复**：发送测试消息验证功能

有问题随时问！
