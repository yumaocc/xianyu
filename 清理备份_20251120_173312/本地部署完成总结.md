# 闲鱼自动化系统 - 本地部署完成总结

## 部署完成状态 ✅

**部署时间：** 2025-11-18
**状态：** 所有服务正常运行

---

## 一、容器运行状态

### 三个容器均已成功启动：

| 容器名称 | 镜像 | 状态 | 端口映射 | 说明 |
|---------|------|------|---------|------|
| xianyu-api | xianyu-backend:latest | healthy | 5000:5000 | 后端 REST API 服务 |
| xianyu-agent | xianyu-backend:latest | running | - | AI 客服代理服务 |
| xianyu-admin | xianyu-xianyu-admin:latest | running | 80:80 | 前端管理界面 |

### 本地访问地址：
- **前端管理界面：** http://localhost:80
- **后端 API：** http://localhost:5000
- **系统状态接口：** http://localhost:5000/api/system/status

---

## 二、Docker 镜像信息

### 已构建的镜像：

| 镜像名称 | 版本 | 大小 | 说明 |
|---------|------|------|------|
| xianyu-backend | latest | 221MB | Python 后端（基于 python:3.10-slim） |
| xianyu-xianyu-admin | latest | 82.7MB | React 前端（基于 nginx:alpine） |

**总镜像大小：** 约 304MB

---

## 三、导出文件（用于服务器部署）

### export/ 目录内容：

```
export/                                  # 总大小：73MB
├── xianyu-backend.tar.gz               # 50MB（后端镜像压缩包）
├── xianyu-admin.tar.gz                 # 22MB（前端镜像压缩包）
├── docker-compose.yml                  # Docker 编排配置
├── deploy-server.sh                    # 服务器一键部署脚本
├── 服务器部署说明.md                    # 详细部署文档
└── data/                               # 数据目录
```

**压缩后总大小：** 73MB（原始镜像 304MB，压缩率 76%）

---

## 四、部署过程中解决的问题

### 1. Docker 镜像下载失败 ✅ 已解决
- **问题：** Docker 配置了代理导致无法下载镜像
- **解决：** 关闭 Docker Desktop 代理设置
- **配置：** 使用阿里云镜像加速器（https://93kbddij.mirror.aliyuncs.com）

### 2. Alpine Linux 构建缓慢 ✅ 已解决
- **问题：** Alpine 基础镜像安装 gcc 等依赖非常慢（20+ 分钟）
- **解决：** 切换到 Debian Slim 基础镜像（python:3.10-slim）
- **效果：** 构建时间从 20+ 分钟降至 17 秒

### 3. 缺少项目文件 ✅ 已解决
- **问题：** Dockerfile 中遗漏了 `delivery_manager.py` 文件
- **解决：** 更新 Dockerfile COPY 指令，包含所有必要文件
- **影响：** 修复后容器启动成功

### 4. 健康检查配置错误 ✅ 已解决
- **问题：** 健康检查使用 `wget` 但镜像中不包含此工具
- **解决：** 改用 Python 内置 urllib 模块进行健康检查
- **配置：**
  ```yaml
  healthcheck:
    test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:5000/api/system/status')"]
  ```

---

## 五、技术架构

### 服务架构：
```
┌─────────────────┐
│  用户浏览器      │
└────────┬────────┘
         │ :80
         ▼
┌─────────────────┐
│  xianyu-admin   │  Nginx + React
│  (前端)         │
└────────┬────────┘
         │ API 调用
         │ :5000
         ▼
┌─────────────────┐
│  xianyu-api     │  Flask REST API
│  (后端 API)     │
└─────────────────┘
         │
         │ 数据库
         ▼
┌─────────────────┐
│  xianyu-agent   │  AI 客服代理
│  (AI Agent)     │  (监听消息并自动回复)
└─────────────────┘
```

### 数据持久化：
- `./XianyuAutoAgent/data/` → 数据库文件
- `./XianyuAutoAgent/prompts/` → AI 提示词模板
- `./XianyuAutoAgent/.env` → 环境配置

---

## 六、部署到服务器的步骤

### 方式一：使用导出的文件（推荐）

1. **上传文件到服务器：**
   ```bash
   scp -r export/ user@your-server-ip:/path/to/deploy/
   ```

2. **在服务器上执行部署：**
   ```bash
   cd /path/to/deploy/export
   chmod +x deploy-server.sh
   ./deploy-server.sh
   ```

3. **访问服务：**
   ```
   http://your-server-ip:80
   ```

### 方式二：在服务器上重新构建

如果服务器可以访问 Docker Hub 或配置了镜像加速：

1. **上传项目文件：**
   ```bash
   scp -r /Users/q/Desktop/xianyu/ user@your-server-ip:/path/to/deploy/
   ```

2. **在服务器上构建并启动：**
   ```bash
   cd /path/to/deploy/xianyu
   ./deploy.sh build
   ./deploy.sh start
   ```

---

## 七、本地管理命令

### 使用 deploy.sh 脚本：
```bash
./deploy.sh build      # 构建镜像
./deploy.sh start      # 启动服务
./deploy.sh stop       # 停止服务
./deploy.sh restart    # 重启服务
./deploy.sh logs       # 查看日志
./deploy.sh status     # 查看状态
./deploy.sh export     # 导出镜像
```

### 使用 docker-compose：
```bash
docker-compose ps                    # 查看容器状态
docker-compose logs -f               # 查看实时日志
docker-compose logs -f xianyu-api    # 查看特定服务日志
docker-compose restart               # 重启所有服务
docker-compose down                  # 停止并删除容器
docker-compose up -d                 # 启动服务
```

---

## 八、环境配置

### 关键配置文件：`XianyuAutoAgent/.env`

需要配置的主要参数：
- `COOKIES_STR` - 闲鱼登录 Cookies
- `AI_API_KEY` - AI 模型 API 密钥
- `AI_BASE_URL` - AI 模型 API 地址

**注意：** 修改 `.env` 后需要重启容器：
```bash
docker-compose restart
```

---

## 九、性能优化

### 构建优化：
1. **使用 Debian Slim 替代 Alpine**
   - 构建时间：17 秒（vs Alpine 20+ 分钟）
   - 镜像大小：221MB（可接受）

2. **使用国内镜像源**
   - Docker 镜像：阿里云加速器
   - Python 包：清华大学 PyPI 镜像

3. **镜像压缩**
   - 原始大小：304MB
   - 压缩后：73MB
   - 压缩率：76%

---

## 十、后续建议

### 生产环境部署建议：

1. **安全加固**
   - 配置 HTTPS（使用 Let's Encrypt）
   - 配置防火墙（只开放必要端口）
   - 定期更新镜像和依赖

2. **监控和日志**
   - 配置日志轮转（避免日志文件过大）
   - 监控容器资源使用情况
   - 设置告警机制

3. **备份策略**
   - 定期备份 `data/` 目录
   - 备份 `.env` 配置文件
   - 保存镜像快照

4. **性能优化**
   - 根据实际负载调整容器资源限制
   - 考虑使用 Gunicorn/uWSGI 替代 Flask 开发服务器
   - 配置 Nginx 缓存和压缩

---

## 十一、故障排查

### 常见问题：

1. **容器无法启动**
   ```bash
   docker-compose logs [container-name]
   ```

2. **端口被占用**
   ```bash
   sudo lsof -i :80
   sudo lsof -i :5000
   ```

3. **健康检查失败**
   - 等待 30 秒让服务完全启动
   - 检查 API 是否能正常响应
   - 查看容器日志

4. **前端无法访问后端**
   - 确认所有容器在同一网络
   - 检查防火墙配置
   - 验证环境变量配置

---

## 十二、文件清单

### 项目根目录：
```
/Users/q/Desktop/xianyu/
├── docker-compose.yml              # Docker 编排配置（已优化）
├── deploy.sh                       # 本地部署脚本
├── 本地部署完成总结.md             # 本文档
├── export/                         # 导出目录（用于服务器部署）
│   ├── xianyu-backend.tar.gz
│   ├── xianyu-admin.tar.gz
│   ├── docker-compose.yml
│   ├── deploy-server.sh
│   ├── 服务器部署说明.md
│   └── data/
├── XianyuAutoAgent/                # 后端项目
│   ├── Dockerfile                  # 后端 Dockerfile（已优化）
│   ├── .env                        # 环境配置
│   ├── requirements.txt
│   └── ...
└── xianyu-admin-web/               # 前端项目
    ├── Dockerfile
    └── ...
```

---

## 总结

✅ **本地部署已完成**，所有服务正常运行
✅ **镜像已导出**，可直接部署到服务器
✅ **文档已完善**，包含详细部署说明
✅ **问题已修复**，所有已知问题均已解决

**下一步：** 将 `export/` 目录上传到服务器，执行一键部署脚本即可完成服务器部署。

---

**部署人员：** Claude Code
**完成时间：** 2025-11-18
**版本：** v2.0
